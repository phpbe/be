tinymce.PluginManager.add("befile", function (editor, url) {
    let pluginName = "插入文件";

    window.befile = {};
    befile.url = editor.getParam("be_storage_url", "", "string");
    befile.selectedFiles = [];

    var openFileManager = function () {
        beimage.selectedFiles = [];
        return editor.windowManager.openUrl({
            title: pluginName,
            size: 'large',
            url: befile.url,
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'custom',
                    text: 'Save',
                    name: 'save',
                    primary: true
                },
            ],
            onAction: function (api, details) {
                switch (details.name) {
                    case 'save':
                        let len = befile.selectedFiles.length;
                        if (len > 0) {
                            let file, html = '';
                            for (let i = 0; i < len; i++) {
                                file = befile.selectedFiles[i];

                                html += '<a href="' + file.url + '"';

                                let title = file.name;
                                if (file.hasOwnProperty("title")) {
                                    title = file.title;
                                }
                                html += ' title="' + title + '"';

                                let target = "_blank"
                                if (file.hasOwnProperty("target")) {
                                    target = file.target;
                                }
                                html += ' target="' + target + '"';

                                html += '>' + file.name + '</a><br>';
                            }
                            editor.insertContent(html);

                            befile.selectedFiles = [];
                        }

                        api.close();
                        break;
                    default:
                        break;
                }

            }
        });
    };

    editor.ui.registry.addButton('befile', {
        icon: 'browse',
        tooltip: pluginName,
        onAction: openFileManager
    });

    editor.ui.registry.addMenuItem('befile', {
        icon: 'browse',
        text: '文件上传...',
        onAction: openFileManager
    });

    return {
        getMetadata: function () {
            return {
                name: pluginName
            };
        }
    };
});
