tinymce.PluginManager.add("beimage", function (editor, url) {
    let pluginName = "插入图片";

    window.beimage = {};
    beimage.url = editor.getParam("be_storage_url_filter_image", "", "string");
    beimage.selectedFiles = [];

    var openFileManager = function () {
        beimage.selectedFiles = [];
        return editor.windowManager.openUrl({
            title: pluginName,
            size: 'large',
            url: beimage.url,
            buttons: [
                {
                    type: 'cancel',
                    text: 'Close'
                },
                {
                    type: 'custom',
                    text: 'Save',
                    name: 'save',
                    primary: true
                },
            ],
            onAction: function (api, details) {
                switch (details.name) {
                    case 'save':
                        let len = beimage.selectedFiles.length;
                        if (len > 0) {
                            let file, html = '';
                            for (let i = 0; i < len; i++) {
                                file = beimage.selectedFiles[i];

                                html += '<img src="' + file.url + '"';

                                let alt = file.name;
                                if (file.hasOwnProperty("alt")) {
                                    alt = file.alt;
                                } else {
                                    if (file.hasOwnProperty("title")) {
                                        alt = file.title;
                                    }
                                }

                                html += ' alt="' + alt + '"';

                                if (file.hasOwnProperty("title")) {
                                    html += ' title="' + file.title + '"';
                                }

                                html += '>';
                            }
                            editor.insertContent(html);

                            beimage.selectedFiles = [];
                        }

                        api.close();
                        break;
                    default:
                        break;
                }

            }
        });
    };

    editor.ui.registry.addButton('beimage', {
        icon: 'image',
        tooltip: pluginName,
        onAction: openFileManager
    });

    editor.ui.registry.addMenuItem('beimage', {
        icon: 'image',
        text: '图片上传...',
        onAction: openFileManager
    });

    return {
        getMetadata: function () {
            return {
                name: pluginName
            };
        }
    };
});
